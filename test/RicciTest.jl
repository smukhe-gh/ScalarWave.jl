#--------------------------------------------------------------------
# Spacetime Discretization methods in Julia
# Soham 04-2018
# Test Ricci and Weyl tensor computations on Schwarzschild
#--------------------------------------------------------------------

using Einsum

struct U end
struct V end
struct UV end

#--------------------------------------------------------------------
# Define boundary and the product space
#--------------------------------------------------------------------
P1, P2 = 20, 20
M = 1.0
SUV = ProductSpace{GaussLobatto{U,P1}, GaussLobatto{V,P2}}

#--------------------------------------------------------------------
# Define coordinates and their associated derivatives
#--------------------------------------------------------------------

t = Field(SUV, (u,v)->u)
r = Field(SUV, (u,v)->v)
Î¸ = Field(SUV, (u,v)->pi/2)
Ï• = Field(SUV, (u,v)->0)

Ã¸ = zero(SUV) 
Ã˜ = zero(Spatial, SUV) 

ğ’• = (5M + 3M)/2 + ((5M - 3M)/2)*t  
ğ’“ = (5M + 3M)/2 + ((5M - 3M)/2)*r  

ğ”»ğ’“, ğ”»ğ’• = derivativetransform(SUV, ğ’•, ğ’“) 
ğ”»Î¸, ğ”»Ï• = Ã˜, Ã˜

#--------------------------------------------------------------------
# Define metric functions 
#--------------------------------------------------------------------

ğ’ˆtt = -(1 - 2M/ğ’“)   
ğ’ˆrr = 1/(1 - 2M/ğ’“)  
ğ’ˆÎ¸Î¸ = ğ’“^2           
ğ’ˆÏ•Ï• = (ğ’“*sin(Î¸))^2  
ğ’ˆrÎ¸ = ğ’ˆrÏ• = ğ’ˆtr = Ã¸ 
ğ’ˆtÎ¸ = ğ’ˆtÏ• = ğ’ˆÎ¸Ï• = Ã¸

ğ•˜    = Metric{dd, 4}([ğ’ˆtt, ğ’ˆtr, ğ’ˆtÎ¸, ğ’ˆtÏ•, 
                           ğ’ˆrr, ğ’ˆrÎ¸, ğ’ˆtÏ•,
                                ğ’ˆÎ¸Î¸, ğ’ˆÎ¸Ï•,
                                     ğ’ˆÏ•Ï•])


ğ•˜inv = metricinverse(ğ•˜) 
ğ”»    = Derivative{u, 4}([ğ”»ğ’•, ğ”»ğ’“, ğ”»Î¸, ğ”»Ï•])

Î“    = Christoffel(ğ•˜)
â„    = Ricci(ğ•˜)

@einsum Î“[m, i, j] = (1/2)*ğ•˜inv[m,k]*(ğ”»[j]*ğ•˜[k,i]+  ğ”»[i]*ğ•˜[k,j] - ğ”»[k]*ğ•˜[i,j])
@einsum â„[i,j] = (ğ”»[l]*Î“[l,i,j] - 0*ğ”»[j]*Î“[l,i,l] + Î“[m,i,j]*Î“[l,l,m] - Î“[m,i,l]*Î“[l,j,m])

#------------------------------------------------------
# Test Christoffels
#------------------------------------------------------


@testset "Î“[a,b,c]" begin
@test maximum(abs(Î“[1,1,2] - (M/ğ’“^2)*((1 - 2(M/ğ’“))^(-1)) )) < 1e-10  # ğ’•ğ’•ğ’“ 
@test maximum(abs(Î“[2,1,1] - (M/ğ’“^2)* (1 - 2(M/ğ’“))       )) < 1e-10  # ğ’“ğ’•ğ’•
@test maximum(abs(Î“[2,2,2] + (M/ğ’“^2)*((1 - 2(M/ğ’“))^(-1)) )) < 1e-10  # ğ’“ğ’“ğ’“
@test maximum(abs(Î“[2,3,3] + (-2*M + ğ’“)                  )) < 1e-10  # ğ’“Î¸Î¸
@test maximum(abs(Î“[2,4,4] + (-2*M + ğ’“)*(sin(Î¸)^2)       )) < 1e-10  # ğ’“Ï•Ï•
@test maximum(abs(Î“[3,2,3] - 1/ğ’“                         )) < 1e-10  # Î¸ğ’“Î¸
@test maximum(abs(Î“[4,2,4] - 1/ğ’“                         )) < 1e-10  # Ï•ğ’“Ï•
@test maximum(abs(Î“[3,4,4] + cos(Î¸)*sin(Î¸)               )) < 1e-10  # Î¸Ï•Ï•
@test maximum(abs(Î“[4,3,4] - (cos(Î¸)/sin(Î¸))             )) < 1e-10  # Ï•Î¸Ï•

indices = ([1,1,2], [2,1,1], [2,2,2], [2,3,3],
           [2,4,4], [3,2,3], [4,2,4],
           [3,4,4], [4,3,4])

for a in 1:4, b in 1:4, c in 1:4
    @test Î“[a, b, c] == Î“[a, c, b]
    if !(([a,b,c] in indices) || ([a,c,b] in indices))
        @test maximum(abs(Î“[a,b,c])) < 1e-10
    end
end

end

#------------------------------------------------------
# Test Ricci 
#------------------------------------------------------

@testset "â„[a,b]" begin
    for a in 1:4, b in 1:4
        @test maximum(abs(â„[a,b])) < 1e-10
    end

    for p in 1:4, q in 1:4
        R  = ( (ğ”»[1]*Î“[1,p,q]+
                ğ”»[2]*Î“[2,p,q]+ 
                ğ”»[3]*Î“[3,p,q]+
                ğ”»[4]*Î“[4,p,q]) 
      
              -(ğ”»[q]*Î“[1,p,1]+
                ğ”»[q]*Î“[2,p,2]+ 
                ğ”»[q]*Î“[3,p,3]+
                ğ”»[q]*Î“[4,p,4])  
       
              +(Î“[1,p,q]*(Î“[1,1,1] + Î“[2,2,1] + Î“[3,3,1] + Î“[4,4,1])+
                Î“[2,p,q]*(Î“[1,1,2] + Î“[2,2,2] + Î“[3,3,2] + Î“[4,4,2])+ 
                Î“[3,p,q]*(Î“[1,1,3] + Î“[2,2,3] + Î“[3,3,3] + Î“[4,4,3])+
                Î“[4,p,q]*(Î“[1,1,4] + Î“[2,2,4] + Î“[3,3,4] + Î“[4,4,4]))  
       
              -(Î“[1,p,1]*Î“[1,q,1]+
                Î“[2,p,1]*Î“[1,q,2]+ 
                Î“[3,p,1]*Î“[1,q,3]+
                Î“[4,p,1]*Î“[1,q,4]+ 
       
                Î“[1,p,2]*Î“[2,q,1]+
                Î“[2,p,2]*Î“[2,q,2]+ 
                Î“[3,p,2]*Î“[2,q,3]+
                Î“[4,p,2]*Î“[2,q,4]+ 
       
                Î“[1,p,3]*Î“[3,q,1]+
                Î“[2,p,3]*Î“[3,q,2]+ 
                Î“[3,p,3]*Î“[3,q,3]+
                Î“[4,p,3]*Î“[3,q,4]+ 
       
                Î“[1,p,4]*Î“[4,q,1]+
                Î“[2,p,4]*Î“[4,q,2]+ 
                Î“[3,p,4]*Î“[4,q,3]+
                Î“[4,p,4]*Î“[4,q,4]) )  
        @show p, q, maximum(abs(R)), maximum(abs(â„[p,q]))
    end
 
end

