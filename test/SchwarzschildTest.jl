#--------------------------------------------------------------------
# Spacetime Discretization methods in Julia
# Soham 04-2018
# Wave equation on Schwarzschild
#--------------------------------------------------------------------

struct U end
struct V end
struct UV end

#--------------------------------------------------------------------
# Define boundary and the product space
#--------------------------------------------------------------------
P1, P2 = 40, 40
M   = 1.0
SUV = ProductSpace{GaussLobatto{U,P1}, GaussLobatto{V,P2}}

#--------------------------------------------------------------------
# Define derivative and boundary operators
#--------------------------------------------------------------------
ğ”¹ = boundary(Null, SUV)

#--------------------------------------------------------------------
# Define coordinates and their associated derivatives
#--------------------------------------------------------------------
u = Field(SUV, (u,v)->u/2)
v = Field(SUV, (u,v)->v/2)

t = Field(SUV, (u,v)->find_t_of_uv(u,v, M))
r = Field(SUV, (u,v)->find_r_of_uv(u,v, M))
Î¸ = Field(SUV, (u,v)->pi/2)
Ï• = Field(SUV, (u,v)->0)
âŠ™ = Field(SUV, (u,v)->0)

ğ”»v, ğ”»u = derivative(SUV)

#--------------------------------------------------------------------
# Define metric functions 
#--------------------------------------------------------------------
ğ’ˆuu = ğ’ˆvv = âŠ™
ğ’ˆuv  = -32*(M^3/r)*(exp(r/M))
ğ’ˆÎ¸Î¸  = r^2
ğ’ˆÏ•Ï•  = (r*sin(Î¸))^2

detğ’ˆ = -1024*(M^6)*r^2/exp((2*r)/M)

#--------------------------------------------------------------------
# Set boundary conditions
#--------------------------------------------------------------------
Ï = 0 
ğ•¤ = exp(-((u^2)/0.1)) 
ğ•“ = ğ”¹*ğ•¤

#--------------------------------------------------------------------
# Now construct the operator 
#--------------------------------------------------------------------
ğ•ƒ = (ğ’ˆuu*ğ”»u*ğ”»u + ğ’ˆvv*ğ”»v*ğ”»v + ğ’ˆuv*ğ”»u*ğ”»v + ğ’ˆvu*ğ”»v*ğ”»u
     + sqrt(1/abs(detğ’ˆ))*(ğ”»u*(ğ’ˆuu*sqrt(abs(detğ’ˆ))) + ğ”»v*(ğ’ˆvu*sqrt(abs(detğ’ˆ))))*ğ”»u
     + sqrt(1/abs(detğ’ˆ))*(ğ”»u*(ğ’ˆuv*sqrt(abs(detğ’ˆ))) + ğ”»v*(ğ’ˆvv*sqrt(abs(detğ’ˆ))))*ğ”»v)

#--------------------------------------------------------------------
# Solve the system [also check the condition number and eigen values]
#--------------------------------------------------------------------
ğ•¨ = solve(ğ•ƒ + ğ”¹, Ï + ğ•“) 
drawpatch(ğ•¨, "plots/schwarzschild")
